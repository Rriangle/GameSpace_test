<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小遊戲 - GameSpace</title>
    <style>
        :root {
            --primary-color: #7557ff;
            --secondary-color: #34d2ff;
            --success-color: #22c55e;
            --text-primary: #1f2937;
            --text-secondary: #64748b;
            --bg-primary: #eef3f8;
            --bg-secondary: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        body.dark {
            --text-primary: #e5edff;
            --text-secondary: #9fb1c9;
            --bg-primary: #0c111b;
            --bg-secondary: #0a0f18;
            --glass-bg: rgba(0, 0, 0, 0.25);
            --glass-border: rgba(255, 255, 255, 0.125);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.65;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        @media (min-width: 768px) {
            .container {
                padding: 0 24px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                padding: 0 32px;
            }
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .nav {
            display: flex;
            gap: 24px;
        }

        .nav a {
            color: var(--text-primary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav a:hover {
            background: var(--glass-bg);
            color: var(--primary-color);
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: #6b46e5;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            padding: 32px 0;
        }

        .page-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 36px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Game Status */
        .game-status {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .status-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px 0 rgba(31, 38, 135, 0.3);
        }

        .status-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .status-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .start-game-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 8px;
        }

        .start-game-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px 0 rgba(117, 87, 255, 0.4);
        }

        .start-game-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Game Selection */
        .game-selection {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
        }

        .selection-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .level-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .level-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px 0 rgba(31, 38, 135, 0.3);
        }

        .level-card.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .level-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .level-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .level-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .level-stats {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Game Canvas */
        .game-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            display: none;
        }

        .game-container.active {
            display: block;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .game-timer {
            background: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .game-canvas {
            width: 100%;
            max-width: 800px;
            height: 400px;
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0 auto;
            display: block;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
        }

        .control-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .control-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .control-btn.danger {
            background: #ef4444;
            color: white;
        }

        .control-btn.danger:hover {
            background: #dc2626;
        }

        /* Game Results */
        .game-results {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            text-align: center;
            display: none;
        }

        .game-results.active {
            display: block;
        }

        .result-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .result-title.victory {
            color: var(--success-color);
        }

        .result-title.defeat {
            color: #ef4444;
        }

        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .reward-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .reward-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .reward-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .reward-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }

        /* Game History */
        .game-history {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .history-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        .history-table th {
            background: var(--glass-bg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-table td {
            color: var(--text-secondary);
        }

        .result-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-badge.win {
            background: var(--success-color);
            color: white;
        }

        .result-badge.lose {
            background: #ef4444;
            color: white;
        }

        .result-badge.abort {
            background: var(--text-secondary);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-title {
                font-size: 28px;
            }
            
            .nav {
                display: none;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .level-grid {
                grid-template-columns: 1fr;
            }
            
            .game-canvas {
                height: 300px;
            }
            
            .game-controls {
                flex-direction: column;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-status,
        .game-selection,
        .game-history {
            animation: fadeInUp 0.6s ease-out;
        }

        .game-status { animation-delay: 0.1s; }
        .game-selection { animation-delay: 0.2s; }
        .game-history { animation-delay: 0.3s; }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .start-game-btn.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .game-canvas.shake {
            animation: shake 0.5s;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">🎮 GameSpace</a>
                <nav class="nav">
                    <a href="index.html">首頁</a>
                    <a href="wallet.html">會員錢包</a>
                    <a href="signin.html">每日簽到</a>
                    <a href="pet.html">寵物系統</a>
                    <a href="minigame.html">小遊戲</a>
                </nav>
                <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">🎯 小遊戲</h1>
                <p class="page-subtitle">帶著你的寵物進行冒險挑戰，每日最多3次機會，獲得豐厚獎勵</p>
            </div>

            <!-- Game Status -->
            <div class="game-status">
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-icon">🎮</div>
                        <div class="status-label">今日剩餘次數</div>
                        <div class="status-value" id="remainingGames">2</div>
                    </div>
                    <div class="status-item">
                        <div class="status-icon">🏆</div>
                        <div class="status-label">勝利場次</div>
                        <div class="status-value" id="winCount">5</div>
                    </div>
                    <div class="status-item">
                        <div class="status-icon">💰</div>
                        <div class="status-label">總獲得點數</div>
                        <div class="status-value" id="totalPoints">350</div>
                    </div>
                    <div class="status-item">
                        <div class="status-icon">🐾</div>
                        <div class="status-label">寵物經驗</div>
                        <div class="status-value" id="petExp">120</div>
                    </div>
                </div>
                <button class="start-game-btn" id="startGameBtn" onclick="startGame()">🚀 開始冒險</button>
                <button class="start-game-btn" onclick="showHistory()">📊 查看紀錄</button>
            </div>

            <!-- Game Selection -->
            <div class="game-selection" id="gameSelection">
                <h3 class="selection-title">選擇關卡</h3>
                <div class="level-grid">
                    <div class="level-card" onclick="selectLevel(1)">
                        <div class="level-icon">🌱</div>
                        <div class="level-name">新手村</div>
                        <div class="level-desc">適合初學者的簡單關卡</div>
                        <div class="level-stats">
                            <span>怪物: 3隻</span>
                            <span>難度: ⭐</span>
                        </div>
                    </div>
                    <div class="level-card" onclick="selectLevel(2)">
                        <div class="level-icon">🌿</div>
                        <div class="level-name">森林深處</div>
                        <div class="level-desc">中等難度的挑戰關卡</div>
                        <div class="level-stats">
                            <span>怪物: 5隻</span>
                            <span>難度: ⭐⭐</span>
                        </div>
                    </div>
                    <div class="level-card" onclick="selectLevel(3)">
                        <div class="level-icon">🏔️</div>
                        <div class="level-name">雪山之巔</div>
                        <div class="level-desc">高難度的終極挑戰</div>
                        <div class="level-stats">
                            <span>怪物: 8隻</span>
                            <span>難度: ⭐⭐⭐</span>
                        </div>
                    </div>
                    <div class="level-card locked">
                        <div class="level-icon">🔥</div>
                        <div class="level-name">地獄深淵</div>
                        <div class="level-desc">傳說中的隱藏關卡</div>
                        <div class="level-stats">
                            <span>怪物: 12隻</span>
                            <span>難度: ⭐⭐⭐⭐</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Container -->
            <div class="game-container" id="gameContainer">
                <div class="game-header">
                    <h3 class="game-title" id="gameTitle">冒險進行中</h3>
                    <div class="game-timer" id="gameTimer">00:00</div>
                </div>
                <canvas class="game-canvas" id="gameCanvas" width="800" height="400"></canvas>
                <div class="game-controls">
                    <button class="control-btn" onclick="pauseGame()">⏸️ 暫停</button>
                    <button class="control-btn danger" onclick="abortGame()">❌ 放棄</button>
                </div>
            </div>

            <!-- Game Results -->
            <div class="game-results" id="gameResults">
                <h2 class="result-title" id="resultTitle">遊戲結束</h2>
                <div class="rewards-grid">
                    <div class="reward-item">
                        <div class="reward-icon">💰</div>
                        <div class="reward-label">獲得點數</div>
                        <div class="reward-value" id="rewardPoints">+50</div>
                    </div>
                    <div class="reward-item">
                        <div class="reward-icon">🐾</div>
                        <div class="reward-label">寵物經驗</div>
                        <div class="reward-value" id="rewardExp">+20</div>
                    </div>
                    <div class="reward-item">
                        <div class="reward-icon">🎁</div>
                        <div class="reward-label">額外獎勵</div>
                        <div class="reward-value" id="rewardBonus">優惠券</div>
                    </div>
                </div>
                <button class="start-game-btn" onclick="closeResults()">繼續冒險</button>
            </div>

            <!-- Game History -->
            <div class="game-history">
                <h3 class="history-title">遊戲紀錄</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>開始時間</th>
                            <th>結束時間</th>
                            <th>關卡</th>
                            <th>結果</th>
                            <th>獲得點數</th>
                            <th>寵物經驗</th>
                            <th>額外獎勵</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2024-12-15 14:30</td>
                            <td>2024-12-15 14:35</td>
                            <td>森林深處</td>
                            <td><span class="result-badge win">勝利</span></td>
                            <td>+80</td>
                            <td>+25</td>
                            <td>85折券</td>
                        </tr>
                        <tr>
                            <td>2024-12-15 10:15</td>
                            <td>2024-12-15 10:18</td>
                            <td>新手村</td>
                            <td><span class="result-badge win">勝利</span></td>
                            <td>+50</td>
                            <td>+15</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>2024-12-14 16:45</td>
                            <td>2024-12-14 16:50</td>
                            <td>雪山之巔</td>
                            <td><span class="result-badge lose">失敗</span></td>
                            <td>+20</td>
                            <td>+5</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>2024-12-14 09:20</td>
                            <td>2024-12-14 09:22</td>
                            <td>森林深處</td>
                            <td><span class="result-badge abort">放棄</span></td>
                            <td>+0</td>
                            <td>+0</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>2024-12-13 15:30</td>
                            <td>2024-12-13 15:35</td>
                            <td>新手村</td>
                            <td><span class="result-badge win">勝利</span></td>
                            <td>+50</td>
                            <td>+15</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>2024-12-13 11:15</td>
                            <td>2024-12-13 11:20</td>
                            <td>森林深處</td>
                            <td><span class="result-badge win">勝利</span></td>
                            <td>+80</td>
                            <td>+25</td>
                            <td>免運券</td>
                        </tr>
                        <tr>
                            <td>2024-12-12 14:45</td>
                            <td>2024-12-12 14:50</td>
                            <td>雪山之巔</td>
                            <td><span class="result-badge win">勝利</span></td>
                            <td>+120</td>
                            <td>+35</td>
                            <td>100元券</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = isDark ? '☀️' : '��';
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark');
            document.querySelector('.theme-toggle').textContent = '☀️';
        }

        // Game data
        let gameData = {
            remainingGames: 2,
            winCount: 5,
            totalPoints: 350,
            petExp: 120,
            selectedLevel: null,
            gameInProgress: false,
            gameStartTime: null,
            gameTimer: null
        };

        // Level data
        const levelData = {
            1: { name: '新手村', monsters: 3, difficulty: 1, baseReward: 50 },
            2: { name: '森林深處', monsters: 5, difficulty: 2, baseReward: 80 },
            3: { name: '雪山之巔', monsters: 8, difficulty: 3, baseReward: 120 }
        };

        // Select level
        function selectLevel(level) {
            if (gameData.gameInProgress) return;
            
            // Remove previous selection
            document.querySelectorAll('.level-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            event.target.closest('.level-card').classList.add('selected');
            
            gameData.selectedLevel = level;
            
            // Enable start button
            const startBtn = document.getElementById('startGameBtn');
            startBtn.disabled = false;
            startBtn.classList.add('pulse');
        }

        // Start game
        function startGame() {
            if (!gameData.selectedLevel || gameData.remainingGames <= 0 || gameData.gameInProgress) {
                alert('無法開始遊戲！');
                return;
            }
            
            gameData.gameInProgress = true;
            gameData.gameStartTime = new Date();
            
            // Hide selection, show game
            document.getElementById('gameSelection').style.display = 'none';
            document.getElementById('gameContainer').classList.add('active');
            
            // Update game title
            const level = levelData[gameData.selectedLevel];
            document.getElementById('gameTitle').textContent = ${level.name} - 冒險進行中;
            
            // Start game timer
            startGameTimer();
            
            // Initialize game canvas
            initGameCanvas();
            
            // Disable start button
            document.getElementById('startGameBtn').disabled = true;
            document.getElementById('startGameBtn').classList.remove('pulse');
        }

        // Start game timer
        function startGameTimer() {
            gameData.gameTimer = setInterval(() => {
                const elapsed = Math.floor((new Date() - gameData.gameStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('gameTimer').textContent = 
                    ${minutes.toString().padStart(2, '0')}:;
            }, 1000);
        }

        // Initialize game canvas
        function initGameCanvas() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw pet
            drawPet(ctx);
            
            // Draw monsters
            drawMonsters(ctx);
            
            // Start game loop
            gameLoop();
        }

        // Draw pet
        function drawPet(ctx) {
            // Pet body
            ctx.fillStyle = '#4ecdc4';
            ctx.beginPath();
            ctx.arc(100, 300, 40, 0, Math.PI * 2);
            ctx.fill();
            
            // Pet eyes
            ctx.fillStyle = '#2c3e50';
            ctx.beginPath();
            ctx.arc(90, 290, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(110, 290, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Pet mouth
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(100, 305, 8, 0, Math.PI);
            ctx.stroke();
        }

        // Draw monsters
        function drawMonsters(ctx) {
            const level = levelData[gameData.selectedLevel];
            const monsterCount = level.monsters;
            
            for (let i = 0; i < monsterCount; i++) {
                const x = 200 + i * 80;
                const y = 300;
                
                // Monster body
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(x, y, 30, 0, Math.PI * 2);
                ctx.fill();
                
                // Monster eyes
                ctx.fillStyle = '#2c3e50';
                ctx.beginPath();
                ctx.arc(x - 10, y - 10, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + 10, y - 10, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // Monster mouth
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y + 5, 6, 0, Math.PI);
                ctx.stroke();
            }
        }

        // Game loop
        function gameLoop() {
            // Simulate game progress
            setTimeout(() => {
                if (gameData.gameInProgress) {
                    // Random chance to end game
                    if (Math.random() < 0.3) {
                        endGame(Math.random() < 0.7 ? 'win' : 'lose');
                    } else {
                        gameLoop();
                    }
                }
            }, 2000);
        }

        // End game
        function endGame(result) {
            gameData.gameInProgress = false;
            
            // Clear timer
            if (gameData.gameTimer) {
                clearInterval(gameData.gameTimer);
            }
            
            // Hide game container
            document.getElementById('gameContainer').classList.remove('active');
            
            // Show results
            showGameResults(result);
            
            // Update game data
            if (result === 'win') {
                gameData.winCount++;
                gameData.remainingGames--;
                gameData.totalPoints += 50;
                gameData.petExp += 20;
            } else {
                gameData.remainingGames--;
                gameData.totalPoints += 20;
                gameData.petExp += 5;
            }
            
            // Update display
            updateGameStatus();
        }

        // Show game results
        function showGameResults(result) {
            const resultsContainer = document.getElementById('gameResults');
            const resultTitle = document.getElementById('resultTitle');
            const rewardPoints = document.getElementById('rewardPoints');
            const rewardExp = document.getElementById('rewardExp');
            const rewardBonus = document.getElementById('rewardBonus');
            
            if (result === 'win') {
                resultTitle.textContent = '🎉 勝利！';
                resultTitle.className = 'result-title victory';
                rewardPoints.textContent = '+50';
                rewardExp.textContent = '+20';
                rewardBonus.textContent = Math.random() < 0.3 ? '優惠券' : '-';
            } else {
                resultTitle.textContent = '😢 失敗';
                resultTitle.className = 'result-title defeat';
                rewardPoints.textContent = '+20';
                rewardExp.textContent = '+5';
                rewardBonus.textContent = '-';
            }
            
            resultsContainer.classList.add('active');
        }

        // Close results
        function closeResults() {
            document.getElementById('gameResults').classList.remove('active');
            document.getElementById('gameSelection').style.display = 'block';
            
            // Reset selection
            document.querySelectorAll('.level-card').forEach(card => {
                card.classList.remove('selected');
            });
            gameData.selectedLevel = null;
            
            // Update start button
            const startBtn = document.getElementById('startGameBtn');
            if (gameData.remainingGames > 0) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
                startBtn.textContent = '今日次數已用完';
            }
        }

        // Pause game
        function pauseGame() {
            if (confirm('確定要暫停遊戲嗎？')) {
                endGame('abort');
            }
        }

        // Abort game
        function abortGame() {
            if (confirm('確定要放棄遊戲嗎？將無法獲得獎勵！')) {
                endGame('abort');
            }
        }

        // Update game status
        function updateGameStatus() {
            document.getElementById('remainingGames').textContent = gameData.remainingGames;
            document.getElementById('winCount').textContent = gameData.winCount;
            document.getElementById('totalPoints').textContent = gameData.totalPoints;
            document.getElementById('petExp').textContent = gameData.petExp;
        }

        // Show history
        function showHistory() {
            document.querySelector('.game-history').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateGameStatus();
            
            // Check if games remaining
            if (gameData.remainingGames <= 0) {
                document.getElementById('startGameBtn').disabled = true;
                document.getElementById('startGameBtn').textContent = '今日次數已用完';
            }
        });
    </script>
</body>
</html>
